# ADR-002: AI Summary Storage Policy

## Status

Accepted

## Context

本アプリでは、申請内容の「購入検討理由」をAIにより自動要約し、承認者が確認できるようにする。

考慮すべき点:

- 差し戻し後に申請内容が変更される可能性がある
- 要約生成に外部APIを使用するため、生成コストや失敗リスクがある
- フルスタックPoCとしての簡潔な設計を優先する
- 永続化の方法を決めないと、差し戻し・再申請時の扱いが曖昧になる

## Decision

1. AI要約は **RDBに保存** する。
   - 申請ごとに `ai_summary` カラムを設ける
   - 承認者が申請内容と共に`ai_summary`を確認する必要があるため、AI要約と申請データの整合性を担保させる
2. 要約生成タイミング
   - 申請が **SUBMITTED** になるタイミングで生成
   - 差し戻し（REJECTED）後に再申請された場合は、再申請処理時に再度AI要約を生成し上書き
3. 表示方法
   - 承認画面では申請本文とは別セクションに表示
   - 編集不可
4. 生成失敗時の扱い
   - 要約生成に失敗しても申請処理は継続可能
   - `ai_summary` は NULL 許容とする
5. Redis等のインメモリDBは使用せず、RDBのみで管理
6. 将来的な拡張:
   - AI要約の履歴を保存する場合や、複数バージョン管理を行う場合は別テーブルを作成

## Alternatives Considered

### インメモリDB（Redis）に保存

- メリット: 再生成コストを抑えられる、キャッシュ感覚で扱える
- デメリット: 差し戻し後に再申請された場合の扱いが不明瞭、PoCとして過剰設計

### 生成時に画面のみ表示（保存せず）

- メリット: DB設計が簡潔
- デメリット: 再表示のたびに生成APIを叩く必要がある、安定性に欠ける

## Consequences

### Positive

- 申請ごとにAI要約を明確に保持
- 再申請時も最新の内容で要約される
- PoC範囲で十分シンプル

### Negative

- 要約生成APIの呼び出しが必須
- DB容量が増える（PoCでは問題なし）

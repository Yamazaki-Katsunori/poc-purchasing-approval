# ADR-002: AI Summary Storage Policy（AI要約の保存方針）

## Status

Accepted

## Context

本アプリでは、購買申請の内容（特に「申請理由 / 購入検討理由」）をAIで要約し、承認者が確認できるようにする。

設計上の前提・課題：

- 申請は差し戻し（RETURNED）後に内容が更新され、再提出（resubmit）される可能性がある
- AI要約は外部LLM API（例: Gemini）を利用するため、呼び出しコスト・失敗リスク・レスポンス遅延がある
- PoCとしてはシンプルな実装を優先しつつ、設計意図（監査性/整合性）を説明可能にしたい
- 本PJでは、監査ログとして `purchasing_approval_events` にイベント履歴を保持し、現在状態は `purchasing_approvals.current_status_id` 等でスナップショット保持する方針（ADR-004）
- AI要約は「どの時点の申請内容に対して生成されたか」が重要であり、申請本文が更新されても過去の要約との対応関係が曖昧にならない設計が必要

そのため、AI要約を「申請（approval）に直接ぶら下げる」よりも、「提出/再提出などのイベントに紐付けて保存する」方が、整合性と監査性を保ちやすい。

## Decision

1. AI要約は **RDBに保存**する（再表示のたびに生成しない）。
2. 保存単位は「申請（purchasing_approvals）」ではなく **イベント（purchasing_approval_events）** とする。
   - 保存先テーブル：`purchasing_approval_ai_summaries`
   - 外部キー：`event_id`（対象イベントに紐付け）
3. 要約生成の対象イベントは **提出系イベント** とする。
   - `action in ("submit", "resubmit")` のイベントを主対象とする -（コメント等のイベントは要約対象外とする）
4. 要約生成タイミング
   - submit（PENDING開始）時に生成を試みる
   - 差し戻し（RETURNED）後の resubmit（再提出）時にも生成を試みる
   - 生成結果は **対応するイベントに紐付けて保存**する（上書きではなくイベントごとに記録）
5. 表示方法
   - 承認画面では「最新の提出系イベント（submit/resubmit）」に紐づく要約を表示する
   - 申請本文とは別セクションに表示し、編集不可とする
6. 生成失敗時の扱い
   - 要約生成に失敗しても、申請/遷移処理（submit/resubmit）は継続可能とする
   - 失敗時は要約レコードを作成しない（または `summary_text` が空の状態で作成しない）※PoCでは「作らない」方針で簡潔にする -（必要に応じて再生成用のAPI/ボタンを将来追加）
7. 将来的な拡張余地
   - `summary_type`（例: short/decision/risk）で複数種の要約を同一イベントに紐付けて保持できる
   - 生成を非同期化（ジョブ化）し、リトライや監視を導入できる
   - 承認者向けに「再生成」や「要約品質の切替」を提供できる

## Alternatives Considered

### A案: purchasing_approvals に ai_summary カラムを設ける（単一スナップショット）

- メリット
  - DB設計・参照が単純（approval を読むだけで要約が取れる）
- デメリット
  - 差し戻し後に本文が更新された場合、どの本文に対する要約か対応関係が曖昧になりやすい
  - 履歴を残す場合は結局別テーブルが必要になる
  - ADR-004 の「events を監査ログの真実とする方針」と噛み合いにくい
- 不採用理由
  - PoCでも「差し戻し→再提出」で内容が変わる前提があり、整合性が崩れやすいため

### B案: 保存せず、表示のたびに生成（オンデマンド）

- メリット
  - DB設計が最も簡潔
  - 常に最新本文から要約できる
- デメリット
  - 表示のたびに外部APIコストが発生し、遅延・失敗に弱い
  - 承認画面のUXが不安定になる
- 不採用理由
  - 承認者が参照する画面の安定性を優先し、RDB保存を選ぶ

### C案: Redis 等のインメモリDBにキャッシュとして保存

- メリット
  - 再表示コストを抑えられる
- デメリット
  - 永続性が弱く、差し戻し後の扱い（どの版に紐付くか）が曖昧になりやすい
  - PoCとして構成が過剰
- 不採用理由
  - PoCはRDBのみでシンプルに運用し、必要になったら再検討する

## Consequences

### Positive

- 「どの時点の申請内容に対する要約か」をイベント単位で明確にでき、差し戻し/再提出でも整合性を保てる
- 承認画面の表示が安定し、外部APIの失敗や遅延の影響を最小化できる
- events に紐付くため、監査ログ・タイムライン・AI要約の関係が説明しやすい（ポートフォリオ向き）
- 将来、要約種別の追加や履歴管理・非同期化へ拡張しやすい

### Negative

- approval 直下の単一カラムより参照が1段増える（events → summaries）
- 生成失敗時の再生成・監視などを本格運用する場合、追加設計が必要になる
- 「最新の提出系イベント」を特定する実装（current_event_id の使い方等）を揃える必要がある

## Notes (Optional)

- PoCの最小ステータスは PENDING / RETURNED / APPROVED を想定し、要約対象は submit/resubmit に限定する
- 要約生成はまず同期実行でも良いが、将来は非同期ジョブ化（リトライ/バックオフ）を検討する
- 表示は「最新の提出系イベント」を基準にするため、current_event_id の定義（状態遷移イベントのみ指す等）を ADR-004 と整合させる
